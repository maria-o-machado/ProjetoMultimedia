<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Nivel2</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1344 , 750, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var plataformas;
var player;
var cursors;
var poderCons=0;
var stars;
var mulher;
var score = 0;
var timeout;

function preload() {
  game.load.image('background', '../resources/backgroundnivelnew2.jpg');
  game.load.image('saude', '../resources/saude.png');
  game.load.image('saudenivel', '../resources/saudenivel.png');
  game.load.image('novochao', '../resources/novochao.png');
  game.load.tilemap('mapa', '../resources/mapaNivel2.json', null, Phaser.Tilemap.TILED_JSON);
  game.load.image('queijoBom', '../resources/QueijoBom.png');
  game.load.image('queijoVenenoso', '../resources/QueijoVenenoso.png');
  game.load.image('toca', '../resources/Toca.png');
  game.load.image('poder', '../resources/Poderes.png');
  game.load.image('armadilha', '../resources/Armadilha3.png');
  game.load.spritesheet('pessoa', '../resources/pessoas.png',1010,2430);
  game.load.spritesheet('rato', '../resources/ratos.png', 166.7, 90);
  game.load.bitmapFont('myfont', '../resources/font.png', '../resources/font.fnt');
}


function create() {

  time= game.add.bitmapText( 1350/2-20, 20, 'myfont', String(parseInt(game.time.totalElapsedSeconds())), 40);
  displayscore= game.add.bitmapText( 1200, 20, 'myfont',String( score), 40);

   //  We're going to be using physics, so enable the Arcade Physics system
  game.physics.startSystem(Phaser.Physics.ARCADE);
  game.scale.pageAlignVertically = true;
  game.scale.pageAlignHorizontally = true;

  //  A simple background for our game
  game.add.tileSprite(0, 0, 3000,750,'background');
  game.world.setBounds(0, 0, 3000, 750);
  saudenivel= game.add.sprite(40, 15, 'saude');
  barrasaude= game.add.sprite(40, 15, 'saudenivel');
  barrasaude.fixedToCamera=true;
  saudenivel.fixedToCamera=true;

  saudenivel.width=280;
  barrasaude.width=280;

  map = game.add.tilemap('mapa');
  map.addTilesetImage( 'novochao');
  map.setCollision([1,2]);
  layer = map.createLayer('Camada de Tiles 1');
  //layer.debug = true;

  //layer.resizeWorld();
  player = game.add.sprite(40, game.world.height - 280 , 'rato');

  // We need to enable physics on the player
  game.physics.arcade.enable(player);

  // Player physics properties. Give the little guy a slight bounce.
  player.body.bounce.y = 0.3;
  player.body.gravity.y = 800;
  player.body.collideWorldBounds = false;
  player.width=104;
  player.height=56;
  player.goesRight=true;

  //  Our two animations, walking left and right.
  player.animations.add('left', [0, 1, 2, 3, 4, 5], 20, true);
  player.animations.add('right', [6, 7, 8, 9, 10, 11], 20, true);

  //QUEIJOS BONS
  queijosB = game.add.group();
  queijosB.enableBody = true;

  queijoB = queijosB.create(875, game.world.height-620, 'queijoBom');
  queijoB.body.gravity.y = 100;
  queijoB.height=50;
  queijoB.width=50;

  queijoB = queijosB.create(2020, game.world.height-600, 'queijoBom');
  queijoB.body.gravity.y = 100;
  queijoB.height=50;
  queijoB.width=50;

  queijoB = queijosB.create(2800, game.world.height-700, 'queijoBom');
  queijoB.body.gravity.y = 100;
  queijoB.height=50;
  queijoB.width=50;

  queijoB = queijosB.create(2370, game.world.height-400, 'queijoBom');
  queijoB.body.gravity.y = 100;
  queijoB.height=50;
  queijoB.width=50;

  //QUEIJOS VENENOSOS
  queijosV = game.add.group();
  queijosV.enableBody = true;
  game.physics.arcade.enable(queijosV);

  queijoV=queijosV.create(430, game.world.height-400,'queijoVenenoso');
  queijoV.body.gravity.y = 100;
  queijoV.height=50;
  queijoV.width=50;

  queijoV=queijosV.create(400, game.world.height-400,'queijoVenenoso');
  queijoV.body.gravity.y = 100;
  queijoV.height=50;
  queijoV.width=50;

  queijoV=queijosV.create(2290, game.world.height-700,'queijoVenenoso');
  queijoV.body.gravity.y = 100;
  queijoV.height=50;
  queijoV.width=50;

  //HUMANOS
  mulher = game.add.sprite(1490, game.world.height - 365 , 'pessoa');
  mulher.width=86
  mulher.height=213
  game.physics.arcade.enable(mulher);
  mulher.body.collideWorldBounds = true;
  mulher.animations.add('left', [0], 9, true);
  mulher.animations.add('right', [1], 9, true);
  mulher.body.velocity.x = 250;
  mulher.animations.play('right');

  mulher1 = game.add.sprite(2700, game.world.height - 660 , 'pessoa');
  mulher1.width=86
  mulher1.height=213
  game.physics.arcade.enable(mulher1);
  mulher1.body.collideWorldBounds = true;
  mulher1.animations.add('left', [0], 9, true);
  mulher1.animations.add('right', [1], 9, true);
  mulher1.body.velocity.x = 300;
  mulher1.animations.play('right');

  mulher2 = game.add.sprite(2295, game.world.height - 485 , 'pessoa');
  mulher2.width=86
  mulher2.height=213
  game.physics.arcade.enable(mulher2);
  mulher2.body.collideWorldBounds = true;
  mulher2.animations.add('left', [0], 9, true);
  mulher2.animations.add('right', [1], 9, true);
  mulher2.body.velocity.x = 200;
  mulher2.animations.play('right');

  //ARMADILHAS
  armadilhas = game.add.group();
  game.physics.arcade.enable(armadilhas);
  armadilhas.enableBody = true;

  armadilha=armadilhas.create(200, game.world.height-450,'armadilha');
  armadilha.body.gravity.y = 100;

  armadilha=armadilhas.create(860, game.world.height-215,'armadilha');
  armadilha.body.gravity.y = 100;

  armadilha=armadilhas.create(2505, game.world.height-700,'armadilha');
  armadilha.body.gravity.y = 100;

  //PODER
  poderes = game.add.group();
  game.physics.arcade.enable(poderes);
  poderes.enableBody = true;
  poderesImunidade=poderes.create(50, game.world.height-600,'poder');
  poderesImunidade.width=60;
  poderesImunidade.height=60;
  poderesImunidade.body.gravity.y = 100;

   //TOCA
  passa = game.add.sprite(2880, game.world.height-190, 'toca');
  game.physics.arcade.enable(passa);
  passa.height = 75;
  passa.width = 94;
  game.camera.follow(player);

  cursors = game.input.keyboard.createCursorKeys();
  game.physics.arcade.checkCollision.top    = false;﻿﻿

}


function resetGame(){
  game.time.reset();
  clearTimeout(timeout);
  poderCons=0;
  score=0;
  game.state.restart();
}

function finish(player) {
  player.kill();
  var tempoTotal=parseInt(game.time.totalElapsedSeconds());
	//O tempo de conclusao maximo para ganhar score com o tempo e 1min e 30 seg
	if (tempoTotal<90000){
		score+=(60 - tempoTotal)*50;
	}
  game.time.reset();
  clearTimeout(timeout);
  poderCons=0;
  for (var key in localStorage) {
	    var score2=localStorage.getItem(key);
	    if (score2==0){
	        var str1 = key;
	        var str2 = "-nivel2";
	        var nome = str1.concat(str2);
	        localStorage.setItem(nome, score);
	        location.href = "nivel3.html";
	    }
	}
  location.href = "nivel3.html"
}

function comerQueijo (player, queijo) {
  score+=100;
  if (saudenivel.width!= 280){
      saudenivel.width+=70;
  }
  queijo.kill();
}

function comerQueijoMau (player, queijoMau) {
  // Removes the star from the screen
  if (poderCons==0){
      saudenivel.width-=70;
      if (saudenivel.width<=0){
          player.kill();
          resetGame();
      }
      queijoMau.kill();
  }
}

function ataqueMulher (player,mulher) {
  if (mulher.body.touching.up){
    score+=50;
    mulher.body.enable = false;
    player.body.velocity.y = -70;
    mulher.animations.stop();
    mulher.kill();
  }
  else{
  if (poderCons==0){
    saudenivel.width-=140;
    mulher.kill();
    if (saudenivel.width<=0){
      player.kill();
      resetGame();
    }
  }
  }
}

function tocarArmadilha (player, armadilha) {
  if (poderCons==0){
    player.kill();
    resetGame();
  }
}

function tocarPoderImunidade (player, poder) {
  poder.kill();
  poderCons=1;
  score+=150;
  timeout= setTimeout(desativaPoder, 15000);
}

function desativaPoder(){
  poderCons=0;
}


function update() {
  player.checkWorldBounds=true;
if (player.body.y> game.world.height){
            resetGame()
        }

  time.destroy();
  time= game.add.bitmapText( 1350/2-20, 20, 'myfont', String(parseInt(game.time.totalElapsedSeconds())), 40);
  time.fixedToCamera=true;
  time.tint=0xfa0013;


  displayscore.destroy()
  displayscore= game.add.bitmapText( 1200, 20, 'myfont',String( score), 40);
  displayscore.fixedToCamera=true;

  //  Collide the player and the stars with the platforms
  var hitPlatform = game.physics.arcade.collide(layer, player);


  game.physics.arcade.collide(queijosB, layer);
  game.physics.arcade.collide(queijosV, layer);
  game.physics.arcade.collide(queijosV, layer);
  game.physics.arcade.collide(armadilhas, layer);
  game.physics.arcade.collide(poderes, layer);
  game.physics.arcade.collide(passa, layer);

  game.physics.arcade.overlap(player, queijosB, comerQueijo, null, this);
  game.physics.arcade.overlap(player, queijosV, comerQueijoMau, null, this);
  game.physics.arcade.overlap(player, mulher, ataqueMulher, null, this);
  game.physics.arcade.overlap(player, mulher1, ataqueMulher, null, this);
  game.physics.arcade.overlap(player, mulher2, ataqueMulher, null, this);
  game.physics.arcade.overlap(player, armadilhas, tocarArmadilha, null, this);
  game.physics.arcade.overlap(player, poderesImunidade, tocarPoderImunidade, null, this);
  game.physics.arcade.overlap(player, passa, finish, null, this);

  if (mulher){
    if (mulher.x <1490){
      mulher.body.velocity.x = 250;
      mulher.animations.play('right');
    }
    else if(mulher.x>1670){
      mulher.body.velocity.x = -250;
      mulher.animations.play('left');
    }
  }

  if (mulher1){
    if (mulher1.x <2700){
      mulher1.body.velocity.x = 300;
      mulher1.animations.play('right');
    }
    else if(mulher1.x >2910){
      mulher1.body.velocity.x = -300;
      mulher1.animations.play('left');
    }
  }

  if (mulher2){
    if (mulher2.x <2295){
      mulher2.body.velocity.x = 200;
      mulher2.animations.play('right');
    }
    else if(mulher2.x >2395){
      mulher2.body.velocity.x = -200;
      mulher2.animations.play('left');
    }
  }

   //  Reset the players velocity (movement)
  player.body.velocity.x = 0;

  if (cursors.left.isDown){
    //  Move to the left
    player.body.velocity.x = -300;

    player.animations.play('left');
    player.goesRight = false;
  }
  else if (cursors.right.isDown){
    //  Move to the right
    player.body.velocity.x = 300;

    player.animations.play('right');
    player.goesRight = true;
  }
  else{
    //  Stand still
    player.animations.stop();

    if (player.goesRight){
      player.frame = 6;
    }
    else{
      player.frame = 5;
    }
  }

  //  Allow the player to jump if they are touching the ground.
  if (cursors.up.isDown && player.body.onFloor() && hitPlatform){
    player.body.velocity.y = -450;
  }
}

</script>
</body>
</html>
